{% extends 'base.html' %}

{% block title %}Dashboard - Infinity School{% endblock %}

{% block header_title %}Dashboard{% endblock %}

{% block head %}
{% endblock %}

{% block header %}
<nav class="nav-menu">
    <div class="left-menu">
        <a href="#" class="btn btn-primary">Dashboard</a>
        <a href="{% url 'perfil' %}" class="btn btn-secondary">Perfil</a>
        <a href="#" class="btn btn-secondary">Anotações</a>
    </div>

    <div class="right-menu">
        <div class="profile-container">
            <img src="{{ user.perfil.foto }}" alt="Foto de Perfil" class="profile-img">
            <span class="username">{{ user.perfil }}</span>
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Logout</button>
            </form>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="welcome-section">
    <h2>Bem-vindo ao Sistema</h2>
    <p>Acesse suas funcionalidades principais</p>
</div>

<div class="dashboard-grid">
    <div class="card">
        <h3>Planilhas</h3>
        <p>Acesse suas planilhas</p>
        <a href="#" class="btn btn-primary">Acessar</a>
    </div>
    
    <div class="card">
        <h3>Portal do aluno</h3>
        <p>Site Portal da Infinity</p>
        <a href="https://infinityschool.eadplataforma.app" class="btn btn-primary">Acessar</a>
    </div>

    <div class="card">
        <h3>Infinity App</h3>
        <p>Aplicativo da Infinity</p>
        <a href="https://www.infinityschool.app" class="btn btn-primary">App</a>
    </div>
    
    <div class="card">
        <h3>Suas Tarefas</h3>
        <p>Lista de tarefas</p>
        <div id="lista-tarefas">
            <!-- Tarefas serão carregadas aqui via JavaScript -->
        </div>
    </div>
    
    <div class="card calendar-card">
        <h3>Calendário</h3>
        <div id="calendar"></div>
    </div>
</div>

<!-- Modal do formulário de tarefa -->
<div id="modal-tarefa" style="display: none;">
    <div id="formulario-tarefa">
        <form id="form-tarefa">
            <h3>Nova Tarefa</h3>

            <div class="form-group">
                <label for="titulo">Título:</label>
                <input type="text" id="titulo" name="titulo" required placeholder="Digite o título da tarefa">
            </div>

            <div class="form-group">
                <label for="tipo">Tipo:</label>
                <input type="text" id="tipo" name="tipo" placeholder="Ex: Reunião, Estudo, Trabalho">
            </div>

            <div class="form-group">
                <label for="colorId">Cor do evento:</label>
                <select name="colorId" id="colorId">
                    <option value="1">🔵 Azul</option>
                    <option value="2">🟢 Verde</option>
                    <option value="3">🟣 Roxo</option>
                    <option value="4">🔴 Vermelho</option>
                    <option value="5">🟠 Laranja</option>
                    <option value="6">🟡 Amarelo</option>
                    <option value="7">🔷 Turquesa</option>
                    <option value="8">⚫ Cinza</option>
                    <option value="9">🔵 Azul Claro</option>
                    <option value="10">🟣 Magenta</option>
                    <option value="11">🟢 Verde Limão</option>
                </select>
            </div>

            <div class="form-group">
                <label for="data-inicio">Início:</label>
                <input type="datetime-local" id="data-inicio" name="inicio" required>
            </div>

            <div class="form-group">
                <label for="data-fim">Fim:</label>
                <input type="datetime-local" id="data-fim" name="fim" required>
            </div>

            <div class="form-buttons">
                <button class="btn btn-primary" type="submit">Salvar Tarefa</button>
                <button class="btn btn-secondary" type="button" id="btn-cancelar">Cancelar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Mapeamento das cores do Google Calendar
    const GOOGLE_COLOR_MAP = {
        '1': '#a4bdfc',   // Azul
        '2': '#7ae7bf',   // Verde
        '3': '#dbadff',   // Roxo
        '4': '#ff887c',   // Vermelho
        '5': '#fbd75b',   // Laranja
        '6': '#ffb878',   // Amarelo
        '7': '#46d6db',   // Turquesa
        '8': '#e1e1e1',   // Cinza
        '9': '#5484ed',   // Azul Claro
        '10': '#51b749', // Magenta
        '11': '#dc2127', // Verde Limão
    };

    var calendarEl = document.getElementById('calendar');

    window.calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        selectable: true,
        headerToolbar: {
            center: '',
            right: 'prev,next today',
            left: 'title'
        },
        footerToolbar: {
            left: '',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
            today:    'Hoje',
            month:    'Mês',
            week:     'Semana',
            day:      'Dia',
            list:     'Lista'
        },

        events: "{% url 'eventos_google_calendar' %}",

        dateClick: function(info) {
            mostrarFormulario();
            // Preenche os inputs do formulário com a data clicada
            const dataFormatada = info.dateStr + "T09:00"; // Exemplo hora 09:00
            document.getElementById('data-inicio').value = dataFormatada;
            document.getElementById('data-fim').value = dataFormatada;
        }
    });
    
    console.log('renderizando calendario')
    calendar.render();
    carregarListaTarefas();

    const form = document.getElementById('form-tarefa');
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const titulo = document.getElementById('titulo').value;
        const tipo = document.getElementById('tipo').value;
        const data_inicio = document.getElementById('data-inicio').value;
        const data_fim = document.getElementById('data-fim').value;
        const colorId = document.getElementById('colorId').value;
        if (new Date(data_inicio) < new Date()) {
            alert("Você não pode criar tarefas no passado!");
            return;
        }
        fetch("{% url 'criar_tarefa' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                titulo,
                tipo,
                data_inicio,
                data_fim,
                colorId  // <-- adicionado aqui
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                calendar.refetchEvents();
                carregarListaTarefas()
                cancelarFormulario()
            } else {
                alert('Erro ao salvar tarefa');
            }
        });
    });
    
    function carregarListaTarefas() {
        fetch("{% url 'tarefas_json' %}")
        .then(response => response.json())
        .then(tarefas => {
            const listaTarefasDiv = document.getElementById('lista-tarefas');
            listaTarefasDiv.innerHTML = '';  // limpa a lista

            tarefas.forEach(tarefa => {
                const tarefaElem = document.createElement('div');
                tarefaElem.className = 'tarefa-item';

                // Obtém a cor baseada no colorId da tarefa
                const cor = GOOGLE_COLOR_MAP[tarefa.colorId] || '#e1e1e1';

                // Cria o indicador de cor
                const indicadorCor = document.createElement('div');
                indicadorCor.className = 'color-indicator';
                indicadorCor.style.backgroundColor = cor;

                const texto = document.createElement('span');
                texto.className = 'tarefa-texto';
                texto.textContent = `${tarefa.titulo} (${tarefa.tipo}) - ${new Date(tarefa.data_inicio).toLocaleString()}`;

                const btnExcluir = document.createElement('button');
                btnExcluir.className = 'btn-excluir';
                btnExcluir.textContent = '🗑️ Excluir';
                btnExcluir.onclick = () => {
                    if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
                        fetch("{% url 'deletar_tarefa' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({ id: tarefa.id })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                carregarListaTarefas();
                                calendar.refetchEvents();
                            } else {
                                alert('Erro ao excluir tarefa: ' + (data.error || 'Erro desconhecido'));
                            }
                        });
                    }
                };

                tarefaElem.appendChild(indicadorCor);
                tarefaElem.appendChild(texto);
                tarefaElem.appendChild(btnExcluir);
                listaTarefasDiv.appendChild(tarefaElem);
            });
        });
    }
    
    function mostrarFormulario() {
        document.getElementById('modal-tarefa').style.display = 'flex';
    }
    
    document.getElementById('btn-cancelar').addEventListener('click', cancelarFormulario);
    
    function cancelarFormulario() {
        document.getElementById('modal-tarefa').style.display = 'none';
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

});
</script>
{% endblock %}

